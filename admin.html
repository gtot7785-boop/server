<script>
    const map = L.map('map').setView([50.7472, 25.3253], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const socket = io({ query: { isAdmin: 'true' } });

    // --- Отримуємо всі елементи сторінки ---
    const gameStatusEl = document.getElementById('game-status');
    const playerCountSpan = document.getElementById('player-count');
    const playerListUl = document.getElementById('player-list');
    const startGameBtn = document.getElementById('start-game-btn');
    const resetGameBtn = document.getElementById('reset-game-btn');
    const gameControls = document.getElementById('game-controls');
    const updateZoneBtn = document.getElementById('update-zone-btn');
    const radiusInput = document.getElementById('zone-radius');
    const broadcastBtn = document.getElementById('broadcast-btn');
    const broadcastMsg = document.getElementById('broadcast-msg');

    // --- Глобальні змінні для карти ---
    let currentZone = null;
    let zoneCircle = null;
    let playerMarkers = {};

    // --- Обробники кнопок ---
    startGameBtn.onclick = () => socket.emit('admin_start_game');
    resetGameBtn.onclick = () => {
        if (confirm('Ви впевнені, що хочете скинути гру? Всі гравці будуть видалені.')) {
            socket.emit('admin_reset_game');
        }
    };
    updateZoneBtn.onclick = () => {
        const newRadius = parseInt(radiusInput.value, 10);
        if (currentZone && newRadius > 0) {
            socket.emit('admin_update_zone', { ...currentZone, radius: newRadius });
        }
    };
    broadcastBtn.onclick = () => {
        if (broadcastMsg.value) {
            socket.emit('admin_broadcast_message', broadcastMsg.value);
            broadcastMsg.value = '';
        }
    };

    // --- Головний обробник подій від сервера ---
    socket.on('game_state_update', (data) => {
        const { gameState, players, zone } = data;
        currentZone = zone;

        // Оновлюємо текст статусу
        gameStatusEl.innerText = gameState;
        startGameBtn.disabled = gameState === 'IN_PROGRESS';

        // Показуємо/ховаємо елементи керування грою
        gameControls.style.display = (gameState === 'IN_PROGRESS') ? 'block' : 'none';

        // Оновлюємо список гравців
        playerCountSpan.innerText = players.length;
        playerListUl.innerHTML = '';
        const updatedPlayerIds = [];
        players.forEach(player => {
            updatedPlayerIds.push(player.id);
            const li = document.createElement('li');
            li.innerText = player.name;
            playerListUl.appendChild(li);

            // Оновлюємо маркери гравців на карті
            if (player.location) {
                const latLng = [player.location.latitude, player.location.longitude];
                if (playerMarkers[player.id]) {
                    playerMarkers[player.id].setLatLng(latLng);
                } else {
                    playerMarkers[player.id] = L.marker(latLng).addTo(map).bindPopup(player.name);
                }
            }
        });

        // Видаляємо маркери гравців, що відключилися
        for (const pId in playerMarkers) {
            if (!updatedPlayerIds.includes(pId)) {
                map.removeLayer(playerMarkers[pId]);
                delete playerMarkers[pId];
            }
        }

        // Оновлення зони на карті
        if (zone) {
            radiusInput.value = zone.radius;
            const center = [zone.latitude, zone.longitude];
            if (zoneCircle) {
                zoneCircle.setLatLng(center).setRadius(zone.radius);
            } else {
                zoneCircle = L.circle(center, { radius: zone.radius, color: 'blue', fillOpacity: 0.1 }).addTo(map);
            }
        }
    });
</script>