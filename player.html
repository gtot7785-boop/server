<script>
    const map = L.map('map').setView([50.7472, 25.3253], 13);
    
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    const urlParams = new URLSearchParams(window.location.search);
    const myUserId = urlParams.get('userId');

    if (!myUserId) {
        document.body.innerHTML = '<h1>Помилка: ID користувача не знайдено.</h1>';
    }

    const socket = io({ query: { userId: myUserId }, transports: ['websocket'] });

    let myMarker = null;
    let zoneCircle = null;

    // Функція для малювання/оновлення зони. Ми будемо викликати її з різних місць.
    function updateZoneOnMap(zoneData) {
        if (!zoneData) return;
        
        console.log(`[MAP] Оновлюю зону на карті. Радіус: ${zoneData.radius}`);
        const center = [zoneData.latitude, zoneData.longitude];
        
        if (zoneCircle) {
            // Якщо коло вже є, оновлюємо його
            zoneCircle.setLatLng(center);
            zoneCircle.setRadius(zoneData.radius);
        } else {
            // Якщо кола немає, створюємо його
            zoneCircle = L.circle(center, { 
                radius: zoneData.radius, 
                color: 'red', 
                fillColor: '#f03', 
                fillOpacity: 0.2 
            }).addTo(map);
        }
    }

    // Слухач для загального оновлення гри (координати + початкове малювання зони)
    socket.on('game_update', (data) => {
        const { players, zone } = data;
        const me = players[0];

        if (me && me.location) {
            const latLng = [me.location.latitude, me.location.longitude];
            if (myMarker) {
                myMarker.moveTo(latLng, 2000);
            } else {
                myMarker = L.animatedMarker([latLng], {
                    icon: L.divIcon({
                        className: 'player-marker',
                        html: `<div style="background-color: #2980b9; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px black;"></div>`,
                        iconSize: [20, 20]
                    })
                }).addTo(map);
                map.setView(latLng, 15);
            }
        }
        
        // Малюємо зону при першому завантаженні
        if (!zoneCircle) {
            updateZoneOnMap(zone);
        }
    });
    
    // !!! ФІНАЛЬНЕ ВИПРАВЛЕННЯ ТУТ !!!
    // Новий, спеціальний слухач тільки для оновлення зони
    socket.on('zone_updated', (newZone) => {
        console.log('✅ Отримано подію zone_updated!', newZone);
        updateZoneOnMap(newZone);
    });

    socket.on('game_event', (message) => {
        const eventContainer = document.getElementById('event-container');
        const eventDiv = document.createElement('div');
        eventDiv.className = 'event-overlay';
        eventDiv.innerText = message;
        eventContainer.appendChild(eventDiv);
        setTimeout(() => eventDiv.remove(), 5000);
    });

    socket.on('connect', () => console.log('Сокет успішно підключено!'));
    socket.on('disconnect', () => console.error('Сокет відключено!'));
</script>